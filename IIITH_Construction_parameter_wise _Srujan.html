<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Outdoor Data Visualization</title>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
      body {
        font-family: "Roboto", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f3f3f3;
      }

      .plot-container {
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: #fff;
        margin: 20px auto;
        width: 95%;
        max-width: 1200px;
        height: 600px;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-top: 20px;
      }

      @media only screen and (max-width: 600px) {
        .plot-container {
          height: 400px;
          margin: 10px auto;
        }
      }
    </style>
  </head>

  <body>
    <h1>Outdoor Environment Data</h1>

    <!-- Plot Containers -->
    <div id="mergedPlot1" class="plot-container"></div>
    <div id="mergedPlot2" class="plot-container"></div>
    <div id="mergedPlot3" class="plot-container"></div>
    <div id="mergedPlot4" class="plot-container"></div>
    <div id="mergedPlot5" class="plot-container"></div>

    <script>
      // Fetch and process data from ThingSpeak
      async function fetchDataAndPlot(channelId, apiKey, location, field) {
        const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?api_key=${apiKey}&results=8000`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          const feeds = data.feeds || [];

          console.log(`Fetched ${feeds.length} feeds for ${location}`);

          if (feeds.length === 0) {
            return {
              x: [],
              y: [],
              name: location + " (No Data)",
              type: "scatter",
              mode: "lines",
            };
          }

          // Group by 5 seconds
          const resampleInterval = 5000;
          let groupedData = {};

          feeds.forEach((feed) => {
            const timestamp = new Date(feed.created_at).getTime();
            const interval = Math.floor(timestamp / resampleInterval) * resampleInterval;
            const val = parseFloat(feed[field]);
            if (!isNaN(val)) {
              if (!groupedData[interval]) groupedData[interval] = [];
              groupedData[interval].push(val);
            }
          });

          // Create averaged timestamps and values
          const timestamps = Object.keys(groupedData).map((interval) => {
            const date = new Date(parseInt(interval));
            const istDate = new Date(date.getTime() + 5.5 * 60 * 60 * 1000); // Convert to IST
            return istDate.toISOString().slice(0, 19).replace("T", " ");
          });

          const values = Object.values(groupedData).map(
            (group) => group.reduce((a, b) => a + b, 0) / group.length
          );

          return {
            x: timestamps,
            y: values,
            name: location,
            type: "scatter",
            mode: "lines",
          };
        } catch (error) {
          console.error(`Error fetching ${location}:`, error);
          return {
            x: [],
            y: [],
            name: location + " (Error)",
            type: "scatter",
            mode: "lines",
          };
        }
      }

      // ThingSpeak Channels
      const channelIds = [
        { id: "3045185", apiKey: "EIJUOIHKF8RZK3KA", label: "Node 1" },
        { id: "3045188", apiKey: "B1YBO3CROCZC02GV", label: "Node 2" },
        { id: "3045189", apiKey: "DROY0BNP5A20USMC", label: "Node 3" },
        { id: "3045192", apiKey: "MI3XQDOQ6WXJKB3P", label: "Node 4" },
      ];

      // Helper to plot fields
      async function plotField(field, containerId, title, yRange, yTitle) {
        const traces = await Promise.all(
          channelIds.map((ch) => fetchDataAndPlot(ch.id, ch.apiKey, ch.label, field))
        );

        const layout = {
          title: { text: title, font: { size: 20 } },
          xaxis: { title: "Timestamp", type: "category", rangeslider: { visible: true } },
          yaxis: { title: yTitle, range: yRange },
          showlegend: true,
          autosize: true,
          margin: { t: 60, r: 30, b: 60, l: 80 },
        };

        Plotly.newPlot(containerId, traces, layout, { responsive: true });
      }

      // Generate plots
      plotField("field1", "mergedPlot1", "Temperature (°C)", [0, 75], "Temperature (°C)");
      plotField("field2", "mergedPlot2", "Humidity (%)", [0, 100], "Humidity (%)");
      plotField("field3", "mergedPlot3", "PM2.5 (µg/m³)", [0, 1000], "PM2.5 (µg/m³)");
      plotField("field4", "mergedPlot4", "PM10 (µg/m³)", [0, 1000], "PM10 (µg/m³)");
      plotField("field5", "mergedPlot5", "Noise (dB)", [30, 130], "Noise (dB)");
    </script>
  </body>
</html>
